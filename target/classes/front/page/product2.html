<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<!--edge浏览器H5兼容设置-->
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title>宠物商城</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!--导入核心文件-->
		<script src="../bootstrap3/js/holder.js"></script>
		<link href="../bootstrap3/css/bootstrap.css" rel="stylesheet" type="text/css">
		<script src="../bootstrap3/jquery-1.9.1.min.js"></script>
		<script src="../bootstrap3/js/bootstrap.js"></script>
		<!-- 字体图标 -->
		<link rel="stylesheet" href="../bootstrap3/font-awesome-4.7.0/css/font-awesome.css" />
		<link rel="stylesheet" type="text/css" href="../css/layout.css" />
		<link rel="stylesheet" type="text/css" href="../css/top.css" />
		<link rel="stylesheet" type="text/css" href="../css/footer.css" />
		<link rel="stylesheet" type="text/css" href="../css/product.css" />
		<link rel="stylesheet" type="text/css" href="../css/imgmove.css" />
		<script src="../js/product.js" type="text/javascript" charset="utf-8"></script>
		<script src="../js/imgmove.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" href="https://unpkg.com/swiper@8/swiper-bundle.min.css">
	</head>
	<style>
		#product-description {
			font-size: 14px;
			font-weight: bold;
			line-height: 1.5;
		}
		h3 {
			word-break: break-all;
		}
		#product-title {
			display: table; /* 将 h3 元素设置为表格形式 */
			margin-left: auto;
			margin-right: auto;
			word-break: break-word; /* 长单词自动换行 */
		}
	</style>
	<body>
		<!--头部-->
		<header class="header">
			<div class="row">
				<div class="col-md-3">
					<a href="index.html">
						<img src="../images/index/stumalllogo.png" />
					</a>
				</div>
				<div class="col-md-6 title-container">
					<h1 id="page-title">它它宠物商城</h1>
				</div>
				<!--快捷选项-->
				<div class="col-md-9 top-item">
					<ul class="list-inline pull-right">
						<li><a href="orders.html"><span class="fa fa-file-text"></span>&nbsp;订单</a></li>
						<li class="li-split">|</li>
						<li><a href="cart.html"><span class="fa fa-cart-plus"></span>&nbsp;购物车</a></li>
						<li class="li-split">|</li>
						<li>
							<!--下列列表按钮 ：管理-->
							<div class="btn-group">
								<button type="button" class="btn btn-link dropdown-toggle" data-toggle="dropdown">
									<span id="top-dropdown-btn"><span class="fa fa-gears"></span>&nbsp;管理 <span class="caret"></span></span>
								</button>
								<ul class="dropdown-menu top-dropdown-ul" role="menu">
									<li><a href="password.html">修改密码</a></li>
									<li><a href="userdata.html">个人资料</a></li>
									<li><a href="upload.html">上传头像</a></li>
									<li><a href="address.html">收货管理	</a></li>
								</ul>
							</div>
						</li>
						<li class="li-split">|</li>
						<li><a href="login.html"><span class="fa fa-user"></span>&nbsp;登录</a></li>
						<li id="user">您好，欢迎光临宠物商城！</li>
						<li><a href="upload.html"><img id="img-avatar" src="../images/index/user.jpg" class="img-responsive" /></a></li>
					</ul>
				</div>
			</div>
		</header>
		<!--导航 -->
		<!--分割导航和顶部-->
		<div class="row top-nav">
			<div class="col-md-6">
				<ul class="nav nav-pills">
					<li>
						<a href="#"></a>
					</li>
					<li class="active"><a href="index.html"><span class="fa fa-home"></span></a></li>
					<li><a href="listSale.html">商品</a></li>
					<li><a href="listLeave.html">礼包</a></li>
					<li><a href="cart.html">购物车</a></li>
					<li><a href="orders.html">订单</a></li>
					<li><a href="password.html">修改信息</a></li>
				</ul>
			</div>
			<div class="col-md-6">
				<form action="search.html" class="form-inline pull-right" role="form">
					<div class="form-group">
						<input type="text" class="form-control" id="search" name="search" placeholder="请输入商品名称进行搜索">
					</div>
					<button type="submit" class="btn btn-default btn-sm"><span class="fa fa-search"></span></button>
				</form>
			</div>
		</div>
		<!--头部结束-->
		<!--导航结束-->
		<!--商品信息展示开始-->
		<div class="container">
			<div class="col-md-offset-1 col-md-10">
				<div class="col-md-6">
					<div data="1" class="img-big move-img col-md-12">
						<img id="product-image-1-big" src="../images/portal/11DELLran7000R1605Ssilvery/1_big.png" class="img-responsive" />
					</div>
					<div data="2" class="img-big move-img col-md-12">
						<img id="product-image-2-big" src="../images/portal/11DELLran7000R1605Ssilvery/2_big.png" class="img-responsive" />
					</div>
					<div data="3" class="img-big move-img col-md-12">
						<img id="product-image-3-big" src="../images/portal/11DELLran7000R1605Ssilvery/3_big.png" class="img-responsive" />
					</div>
					<div data="4" class="img-big move-img col-md-12">
						<img id="product-image-4-big" src="../images/portal/11DELLran7000R1605Ssilvery/4_big.png" class="img-responsive" />
					</div>
					<div data="1" class="col-md-2 img-small">
						<img id="product-image-1" src="../images/portal/11DELLran7000R1605Ssilvery/1.jpg" class="img-responsive" />
					</div>
					<div data="2" class="col-md-2 img-small">
						<img id="product-image-2" src="../images/portal/11DELLran7000R1605Ssilvery/2.jpg" class="img-responsive" />
					</div>
					<div data="3" class="col-md-2 img-small">
						<img id="product-image-3" src="../images/portal/11DELLran7000R1605Ssilvery/3.jpg" class="img-responsive" />
					</div>
					<div data="4" class="col-md-2 img-small">
						<img id="product-image-4" src="../images/portal/11DELLran7000R1605Ssilvery/4.jpg" class="img-responsive" />
					</div>
					<div class="col-md-offset-1 col-md-10">
						<div class="panel panel-default">
							<div class="panel-heading">
								<h2 class="panel-title">售后承诺</h2>
							</div>
							<div class="panel-body ">
								<div class="row">
									<div class="col-md-1 saled-icon"><span class="fa fa-shield"></span></div>
									<div class="col-md-11 saled-title">正品保障</div>
								</div>
								<div class="row">
									<p class="col-md-offset-1 col-md-11 saled-content">宠物商城向您保证所售商品均为正品</p>
								</div>
								<div class="row">
									<div class="col-md-1 saled-icon"><span class="fa fa-wrench"></span></div>
									<div class="col-md-11 saled-title">店家服务</div>
								</div>
								<div class="row">
									<p class="col-md-offset-1 col-md-11 saled-content">若有缺磨损失全额退款</p>
								</div>
								<div class="row">
									<div class="col-md-1 saled-icon"><span class="fa fa-heartbeat"></span></div>
									<div class="col-md-11 saled-title">郑重承诺</div>
								</div>
								<div class="row">
									<p class="col-md-offset-1 col-md-11 saled-content">宠物商城销售并发货的商品，必由管理员提供售后服务
									</p>
								</div>
								<div class="row">
									<div class="col-md-1 saled-icon"><span class="fa fa-reply"></span></div>
									<div class="col-md-11 saled-title">无忧退货</div>
								</div>
								<div class="row">
									<p class="col-md-offset-1 col-md-11 saled-content">购买七日未使用无条件退款</p>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-md-6">
					<h3 id="product-title" class="col-md-12 title-row-1"></h3>
					<div class="col-md-12 price-bar">
						<small>售价：</small> ¥<span id="product-price"></span>
						<div id="saved-amount"></div>
						<div><small>*退货补运费 *7天无理由退货 *24小时快速退款 </small></div>
					</div>
					<div class="col-md-12 price-bar">
						<small>礼包剩余数量：</small> <span id="product-amout"></span>
					</div>
					<form class="form-inline product-form col-md-12" role="form">
						<ul id="leave-conditions"></ul>
						<div class="col-md-12 form-space">
							<label for="num">数量：</label>
							<input id="numDown" type="button" value="-" class="num-btn" />
							<input id="num" type="text" size="2" readonly="readonly" class="num-text" value="1">
							<input id="numUp" class="num-btn" type="button" value="+" />
						</div>
						<div class="col-md-12 form-space">
							<p><small><b>宠物商城</b>发货</small></p>
						</div>
						<div>商品详情</div>
						<div id="product-description" class="col-md-12 form-space"></div>
						<div class="col-md-12 form-space">
							<input id="btn-to-order" class="btn btn-primary btn-lg btn-block" type="button" value="立即购买">
						</div>
					</form>
					<div class="col-md-offset-1 col-md-10">
						<form class="form-horizontal">
							<textarea id="comment-content" class="form-control" rows="3" placeholder="请输入评论内容..."></textarea>
							<button id="comment-submit" type="button" class="btn btn-primary pull-right">发表评论</button>

							<div class="comment-count-wrapper text-success">
								<span>全部评论（<span id="comment-count"></span>）</span>
							</div>
						</form>
					</div>

					<!-- 将小图缩略图列表放在大图片下面 -->

					<div class="col-md-12 form-space"></div>

					<!-- 将评论列表放在大图片下面 -->

					<div class="col-md-12 form-space"></div>

					<div class="col-md-12">
						<div id="comment-list"></div>
					</div>
				</div>
			</div>
		</div>
		<div class="footer-top">
			<div class="container">
				<div class="row">
					<div class="col-lg-3 col-md-6">
						<div class="footer-widget">
							<h3 class="widget-title">关于我们</h3>
							<p>我们提供正品保障的宠物用品，让你的宠物生活更愉快。欢迎加入我们的爱宠家庭。</p>
						</div>
					</div>
					<div class="col-lg-3 col-md-6">
						<div class="footer-widget">
							<h3 class="widget-title">品类丰富</h3>
							<ul class="footer-link">
								<li><a href="listSale2.html?categoryId=16">猫粮</a></li>
								<li><a href="listSale2.html?categoryId=17">狗粮</a></li>
								<li><a href="listSale2.html?categoryId=18">宠物玩具</a></li>
								<li><a href="listSale2.html?categoryId=19">宠物用品</a></li>
								<li><a href="listSale2.html?categoryId=20">宠物服饰</a></li>
							</ul>
						</div>
					</div>
					<div class="col-lg-3 col-md-6">
						<div class="footer-widget">
							<h3 class="widget-title">优质服务</h3>
							<ul class="footer-link">
								<li><a href="shopPlan.html">购物指南</a></li>
								<li><a href="paymentQE.html">支付问题</a></li>
								<li><a href="saleBack.html">售后服务</a></li>
								<li><a href="returnSale.html">退换货政策</a></li>
							</ul>
						</div>
					</div>
					<div class="col-lg-3 col-md-6">
						<div class="footer-widget">
							<h3 class="widget-title">联系我们</h3>
							<ul class="footer-contact">
								<li><i class="fas fa-map-marker-alt"></i> </li>
								<li><i class="fas fa-phone"></i> </li>
								<li><i class="fas fa-envelope"></i> </li>
								<li><i class="fas fa-clock"></i> 09:00-18:30 (周一到周日)</li>
							</ul>
						</div>
					</div>
				</div>
				<!-- 返回顶部按钮 -->
				<div class="row">
					<div class="col-md-12 text-center">
						<a href="#" class="back-to-top">返回顶部<i class="fas fa-chevron-up"></i></a>
					</div>
				</div>
			</div>
		</div>
		<div class="footer-bottom">
			<div class="container">
				<div class="row">
					<div class="col-md-6">
						<p>© 2023 爱宠20年. All Rights Reserved.</p>
					</div>
					<div class="col-md-6">
						<div class="footer-payment">
							<img src="img/payment.jpg" alt="Payment Method" width="80" height="auto">
						</div>
					</div>
				</div>
			</div>
		</div>
		</footer>
		<script type="text/javascript" src="../js/jquery-getUrlParam.js"></script>
		<script type="text/javascript">
			let id = $.getUrlParam("id");
			console.log("id=" + id);
			$(document).ready(function() {
				function escapeHtml(text) {
					var map = {
						"&": "&amp;",
						"<": "&lt;",
						">": "&gt;",
						" ": "&nbsp;",
						"\n": "<br>",
						"\r": "<br>"
					};
					return text.replace(/[&<>\n\r ]/g, function(m) { return map[m]; });
				}
				var imgList; // 图片列表
				var imgIndex = 0; // 记录当前展示的图片的索引
				function loadComments() {
					$.ajax({
						url: "/comments/leave",
						type: "GET",
						data: {
							"productId": id
						},
						dataType: "JSON",
						success: function(json) {
							if (json.state == 200) {
								var comments = json.data;
								var totalCount = comments.length; // 获取评论总数
								$("#comment-count").text(totalCount); // 将评论总数设置到相应的元素上
								if (totalCount > 0) {
									var html = "";
									for (var i = 0; i < comments.length; i++) {
										var comment = comments[i];
										html += "<div class='panel panel-default'>";
										html += "<div class='panel-heading'>" + comment.username + " 说：</div>";
										html += "<div class='panel-body'>" + comment.content + "</div>";
										html += "<div class='panel-footer text-right'>" + comment.createdTime + "</div>";
										html += "</div>";
									}
									$("#comment-list").html(html);
								}
							} else {
								alert("获取评论列表失败！" + json.message);
							}
						}
					});
				}

				// 加载评论列表
				loadComments();

				// 发表评论
				$("#comment-submit").click(function() {
					var content = $("#comment-content").val().trim();
					if (content == "") {
						alert("评论内容不能为空！");
						return;
					}
					$.ajax({
						url: "/comments/leaveAdd",
						type: "POST",
						data: {
							"productId": id,
							"content": content
						},
						dataType: "JSON",
						success: function(json) {
							if (json.state == 200) {
								alert("评论成功！");
								// 刷新评论列表
								loadComments();
							} else if (json.state == 4003) {
								alert("请先登录再评论！");
								location.href = "login.html";
							} else {
								alert("评论失败！" + json.message);
							}
						}
					});
				});
				$.ajax({
					url: "/petLeave/" + id + "/details",
					type: "GET",
					dataType: "JSON",
					success: function(json) {
						if (json.state == 200) {
							console.log("title=" + json.data.name);
							$("#product-title").html(json.data.name);
							$("#product-price").html(json.data.price/100);
							$("#product-amout").html(json.data.amout);
							var productPrice = json.data.price/100;
							var leaveConditionsTotalPrice = 0;

							for (var i = 0; i < json.data.leaveConditions.length; i++) {
								var leaveCondition = json.data.leaveConditions[i];
								var leaveConditionStr = '<li>' + leaveCondition.name + '商品个数：' + leaveCondition.copies + '</li>' +
										'<li>单价是：' + leaveCondition.price/100 + '</li>' +
										'<li>总价是：' + leaveCondition.price/100*leaveCondition.copies + '</li>';

								$("#leave-conditions").append(leaveConditionStr);

								leaveConditionsTotalPrice += leaveCondition.price/100*leaveCondition.copies;
							}

							var savedPrice = leaveConditionsTotalPrice - json.data.price/100;
							$("#saved-amount").html("劲省 " + savedPrice.toFixed(2) + " 元");
							var description = json.data.description || "暂无描述"; // 判断是否有描述信息，并赋值，如果没有则为"暂无描述"
							var escapedDescription = escapeHtml(description); // 将特殊字符转义成 HTML 实体
							$("#product-description").html(escapedDescription); // 将转义后的商品描述信息展示到页面上
							imgList = json.data.image.split(","); // 将 image 数据以逗号分隔，并存储到 imgList 数组中
							// 显示前四张图片
							$("#product-image-1-big").attr("src", "/front/page/p/" + imgList[0]);
							$("#product-image-2-big").attr("src", "/front/page/p/" + (imgList[1] || imgList[0])); // 如果没有第二张图片，则显示第一张图片
							$("#product-image-3-big").attr("src", "/front/page/p/" + (imgList[2] || imgList[0])); // 如果没有第三张图片，则显示第一张图片
							$("#product-image-4-big").attr("src", "/front/page/p/" + (imgList[3] || imgList[0])); // 如果没有第四张图片，则显示第一张图片
							$("#product-image-1").attr("src", "/front/page/p/" + imgList[0]);
							$("#product-image-2").attr("src", "/front/page/p/" + (imgList[1] || imgList[0])); // 如果没有第二张图片，则显示第一张图片
							$("#product-image-3").attr("src", "/front/page/p/" + (imgList[2] || imgList[0])); // 如果没有第三张图片，则显示第一张图片
							$("#product-image-4").attr("src", "/front/page/p/" + (imgList[3] || imgList[0])); // 如果没有第四张图片，则显示第一张图片
							// 显示小图缩略图列表
							for (var i = 0; i < imgList.length; i++) {
								var thumbnail = '<img class="product-thumbnail" src="/front/page/p/' + imgList[i] + '"/>';
								$("#product-thumbnail-container").append(thumbnail);
							}
							// 绑定小图缩略图点击事件
							$(".product-thumbnail").on("click", function() {
								var index = $(".product-thumbnail").index(this); // 获取当前点击小图在数组中的索引
								imgIndex = index; // 更新当前展示的图片索引
								showBigImage(); // 加载并显示当前选中的图片
							});
							$(".product-thumbnail").css({"width": "80px", "height": "80px", "margin": "5px 10px"});
							// 定时器轮播图片
							setInterval(function() {
								if (imgIndex < imgList.length - 1) {
									imgIndex++;
								} else {
									imgIndex = 0;
								}
								showBigImage(); // 加载并显示当前展示的图片
							}, 3000); // 设置图片切换时间为3秒
						} else if (json.state == 4006) { // 商品数据不存在的异常
							alert("商品数据不存在，可能后台变动，请重新登录刷新");
							location.href = "index.html";
						} else {
							alert("获取商品信息失败！" + json.message);
						}
					}
				});
				function showBigImage() {
					var currentImage = imgList[imgIndex];
					$("#product-image-1-big").attr("src", "/front/page/p/" + currentImage);
					$(".product-thumbnail").removeClass("product-thumbnail-active"); // 取消所有小图的选中状态
					$(".product-thumbnail:eq(" + imgIndex + ")").addClass("product-thumbnail-active"); // 将当前选中的小图设置为选中状态
				}
			});
			$("#btn-to-order").click(function() {
				$.ajax({
					url: "/orders/createOneLeave",
					type: "POST",
					data: {
						"pid": id,
						"amount": $("#num").val()
					},
					dataType: "JSON",
					success: function(json) {
						if (json.state == 200) {
							alert("购买成功，请到订单界面查看！");
							location.href = "orders.html";
						} else {
							alert("购买失败！" + json.message);
						}
					},
					error: function(xhr) {
						alert("您的登录信息已经过期，请重新登录！HTTP响应码：" + xhr.status);
						location.href = "login.html";
					}
				});
			});
		</script>
	</body>
</html>